name: Release

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  extract_version:
    name: Extract Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git-cliff
        uses: kenji-miyake/setup-git-cliff@v1

      - name: Set version name
        id: set_version
        run: echo "version=$(git cliff --bumped-version --include-path \"packages/**/*\")" >> "$GITHUB_OUTPUT"

  migrations:
    name: Check Migrations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Build migrations
        run: bash ./scripts/build-migrations.sh

      - name: Format
        run: bun run oxfmt

      - name: Check for changes
        run: |
          git diff --exit-code || \
          (echo "Error: Generated migration files are out of date. Run 'just build-migrations && just format' and commit the changes." && exit 1)

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Lint
        run: bun run oxlint --type-aware --deny-warnings

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Typecheck
        working-directory: packages/pgconductor-js
        run: bun run typecheck

  unit_test:
    name: Unit Test
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Unit Tests
        working-directory: packages/pgconductor-js
        run: bun run test:unit

  integration_test:
    name: Integration Test (Postgres ${{ matrix.pg }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        pg: [15, 16, 17]

    services:
      postgres:
        image: postgres:${{ matrix.pg }}
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Integration Tests
        working-directory: packages/pgconductor-js
        run: bun run test:integration
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres

  create_release:
    name: Create GitHub Release Draft
    runs-on: ubuntu-latest
    needs: [extract_version, migrations, lint, typecheck, unit_test, integration_test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Changelog
        uses: orhun/git-cliff-action@v4
        id: changelog
        with:
          config: cliff.toml
          args: --bump --unreleased --include-path "packages/**/*"
        env:
          GITHUB_REPO: ${{ github.repository }}

      - name: Ensure tag matches
        if: steps.changelog.outputs.version != needs.extract_version.outputs.version
        run: |
          echo "Tag does not match: ${{ steps.changelog.outputs.version }} vs ${{ needs.extract_version.outputs.version }}"
          exit 1

      - name: Create Release
        uses: softprops/action-gh-release@v2
        id: create-release
        with:
          body: |
            ${{ steps.changelog.outputs.content }}
          tag_name: ${{ steps.changelog.outputs.version }}
          draft: true

      - name: Output Link to Workflow Summary
        run: |
          {
            echo "# ðŸ“ Release Draft Created!"
            echo ""
            echo "## Next Steps"
            echo "1. Review the release draft: [Link](${{ steps.create-release.outputs.url }})"
            echo "2. Edit the release notes if needed"
            echo "3. Click **Publish Release**"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"


